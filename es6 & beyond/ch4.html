
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Chapter 4: Async Flow Control Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-okaidia.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ch5.html" />
    
    
    <link rel="prev" href="ch3.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../preface.html">
            
                <a href="../preface.html">
            
                    
                    Preface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../up & going/toc.html">
            
                <a href="../up & going/toc.html">
            
                    
                    Up & Going
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../up & going/foreword.html">
            
                <a href="../up & going/foreword.html">
            
                    
                    Foreword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../up & going/ch1.html">
            
                <a href="../up & going/ch1.html">
            
                    
                    Chapter 1: Into Programming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../up & going/ch2.html">
            
                <a href="../up & going/ch2.html">
            
                    
                    Chapter 2: Into JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../up & going/ch3.html">
            
                <a href="../up & going/ch3.html">
            
                    
                    Chapter 3: Into YDKJS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../up & going/apA.html">
            
                <a href="../up & going/apA.html">
            
                    
                    Appendix A: Thank You's!
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Scope & Closures/toc.html">
            
                <a href="../Scope & Closures/toc.html">
            
                    
                    Scope & Closures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../Scope & Closures/ch1.html">
            
                <a href="../Scope & Closures/ch1.html">
            
                    
                    Chapter 1: What is Scope?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../Scope & Closures/ch2.html">
            
                <a href="../Scope & Closures/ch2.html">
            
                    
                    Chapter 2: Lexical Scope
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../Scope & Closures/ch3.html">
            
                <a href="../Scope & Closures/ch3.html">
            
                    
                    Chapter 3: Function vs. Block Scope
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../Scope & Closures/ch4.html">
            
                <a href="../Scope & Closures/ch4.html">
            
                    
                    Chapter 4: Hoisting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../Scope & Closures/ch5.html">
            
                <a href="../Scope & Closures/ch5.html">
            
                    
                    Chapter 5: Scope Closures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../Scope & Closures/apA.html">
            
                <a href="../Scope & Closures/apA.html">
            
                    
                    Appendix A: Dynamic Scope
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../Scope & Closures/apB.html">
            
                <a href="../Scope & Closures/apB.html">
            
                    
                    Appendix B: Polyfilling Block Scope
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../Scope & Closures/apC.html">
            
                <a href="../Scope & Closures/apC.html">
            
                    
                    Appendix C: Lexical-this
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../Scope & Closures/apD.html">
            
                <a href="../Scope & Closures/apD.html">
            
                    
                    Appendix D: Thank You's!
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../this & Object Prototypes/toc.html">
            
                <a href="../this & Object Prototypes/toc.html">
            
                    
                    this & Object Prototypes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../this & Object Prototypes/foreword.html">
            
                <a href="../this & Object Prototypes/foreword.html">
            
                    
                    Foreword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../this & Object Prototypes/ch1.html">
            
                <a href="../this & Object Prototypes/ch1.html">
            
                    
                    Chapter 1: this Or That?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../this & Object Prototypes/ch2.html">
            
                <a href="../this & Object Prototypes/ch2.html">
            
                    
                    Chapter 2: this All Makes Sense Now!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../this & Object Prototypes/ch3.html">
            
                <a href="../this & Object Prototypes/ch3.html">
            
                    
                    Chapter 3: Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../this & Object Prototypes/ch4.html">
            
                <a href="../this & Object Prototypes/ch4.html">
            
                    
                    Chapter 4: Mixing (Up) "Class" Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../this & Object Prototypes/ch5.html">
            
                <a href="../this & Object Prototypes/ch5.html">
            
                    
                    Chapter 5: Prototypes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="../this & Object Prototypes/ch6.html">
            
                <a href="../this & Object Prototypes/ch6.html">
            
                    
                    Chapter 6: Behavior Delegation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="../this & Object Prototypes/apA.html">
            
                <a href="../this & Object Prototypes/apA.html">
            
                    
                    Appendix A: ES6 class
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="../this & Object Prototypes/apB.html">
            
                <a href="../this & Object Prototypes/apB.html">
            
                    
                    Appendix B: Thank You's!
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Types & Grammar/toc.html">
            
                <a href="../Types & Grammar/toc.html">
            
                    
                    Types & Grammar
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Types & Grammar/foreword.html">
            
                <a href="../Types & Grammar/foreword.html">
            
                    
                    Foreword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Types & Grammar/ch1.html">
            
                <a href="../Types & Grammar/ch1.html">
            
                    
                    Chapter 1: Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Types & Grammar/ch2.html">
            
                <a href="../Types & Grammar/ch2.html">
            
                    
                    Chapter 2: Values
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Types & Grammar/ch3.html">
            
                <a href="../Types & Grammar/ch3.html">
            
                    
                    Chapter 3: Natives
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Types & Grammar/ch4.html">
            
                <a href="../Types & Grammar/ch4.html">
            
                    
                    Chapter 4: Coercion
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../Types & Grammar/ch5.html">
            
                <a href="../Types & Grammar/ch5.html">
            
                    
                    Chapter 5: Grammar
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../Types & Grammar/apA.html">
            
                <a href="../Types & Grammar/apA.html">
            
                    
                    Appendix A: Mixed Environment JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="../Types & Grammar/apB.html">
            
                <a href="../Types & Grammar/apB.html">
            
                    
                    Appendix B: Thank You's!
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../Async & Performance/toc.html">
            
                <a href="../Async & Performance/toc.html">
            
                    
                    Async & Performance
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../Async & Performance/foreword.html">
            
                <a href="../Async & Performance/foreword.html">
            
                    
                    Foreword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../Async & Performance/ch1.html">
            
                <a href="../Async & Performance/ch1.html">
            
                    
                    Chapter 1: Asynchrony: Now & Later
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../Async & Performance/ch2.html">
            
                <a href="../Async & Performance/ch2.html">
            
                    
                    Chapter 2: Callbacks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../Async & Performance/ch3.html">
            
                <a href="../Async & Performance/ch3.html">
            
                    
                    Chapter 3: Promises
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../Async & Performance/ch4.html">
            
                <a href="../Async & Performance/ch4.html">
            
                    
                    Chapter 4: Generators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../Async & Performance/ch5.html">
            
                <a href="../Async & Performance/ch5.html">
            
                    
                    Chapter 5: Program Performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="../Async & Performance/ch6.html">
            
                <a href="../Async & Performance/ch6.html">
            
                    
                    Chapter 6: Benchmarking & Tuning
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="../Async & Performance/apA.html">
            
                <a href="../Async & Performance/apA.html">
            
                    
                    Appendix A: Library: asynquence
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9" data-path="../Async & Performance/apB.html">
            
                <a href="../Async & Performance/apB.html">
            
                    
                    Appendix B: Advanced Async Patterns
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.10" data-path="../Async & Performance/apC.html">
            
                <a href="../Async & Performance/apC.html">
            
                    
                    Appendix C: Thank You's!
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="toc.html">
            
                <a href="toc.html">
            
                    
                    ES6 & Beyond
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="foreword.html">
            
                <a href="foreword.html">
            
                    
                    Foreword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="ch1.html">
            
                <a href="ch1.html">
            
                    
                    Chapter 1: ES? Now & Future
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="ch2.html">
            
                <a href="ch2.html">
            
                    
                    Chapter 2: Syntax
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="ch3.html">
            
                <a href="ch3.html">
            
                    
                    Chapter 3: Organization
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.8.5" data-path="ch4.html">
            
                <a href="ch4.html">
            
                    
                    Chapter 4: Async Flow Control
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="ch5.html">
            
                <a href="ch5.html">
            
                    
                    Chapter 5: Collections
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="ch6.html">
            
                <a href="ch6.html">
            
                    
                    Chapter 6: API Additions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.8" data-path="ch7.html">
            
                <a href="ch7.html">
            
                    
                    Chapter 7: Meta Programming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.9" data-path="ch8.html">
            
                <a href="ch8.html">
            
                    
                    Chapter 8: Beyond ES6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.10" data-path="apA.html">
            
                <a href="apA.html">
            
                    
                    Appendix A: Thank You's!
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Chapter 4: Async Flow Control</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#you-dont-know-js-es6--beyond"><b>1. </b>You Don&apos;t Know JS: ES6 &amp; Beyond</a></li><li><span class="title-icon "></span><a href="#chapter-4-async-flow-control"><b>2. </b>Chapter 4: Async Flow Control</a></li><ul><li><span class="title-icon "></span><a href="#promises"><b>2.1. </b>Promises</a></li><ul><li><span class="title-icon "></span><a href="#making-and-using-promises"><b>2.1.1. </b>Making and Using Promises</a></li><li><span class="title-icon "></span><a href="#thenables"><b>2.1.2. </b>Thenables</a></li><li><span class="title-icon "></span><a href="#promise-api"><b>2.1.3. </b>Promise API</a></li></ul><li><span class="title-icon "></span><a href="#generators--promises"><b>2.2. </b>Generators + Promises</a></li><li><span class="title-icon "></span><a href="#review"><b>2.3. </b>Review</a></li></ul></ul></div><a href="#you-dont-know-js-es6--beyond" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="you-dont-know-js-es6--beyond"><a name="you-dont-know-js-es6--beyond" class="anchor-navigation-ex-anchor" href="#you-dont-know-js-es6--beyond"><i class="fa fa-link" aria-hidden="true"></i></a>1. You Don&apos;t Know JS: ES6 &amp; Beyond</h1>
<h1 id="chapter-4-async-flow-control"><a name="chapter-4-async-flow-control" class="anchor-navigation-ex-anchor" href="#chapter-4-async-flow-control"><i class="fa fa-link" aria-hidden="true"></i></a>2. Chapter 4: Async Flow Control</h1>
<p>It&apos;s no secret if you&apos;ve written any significant amount of JavaScript that asynchronous programming is a required skill. The primary mechanism for managing asynchrony has been the function callback.</p>
<p>However, ES6 adds a new feature that helps address significant shortcomings in the callbacks-only approach to async: <em>Promises</em>. In addition, we can revisit generators (from the previous chapter) and see a pattern for combining the two that&apos;s a major step forward in async flow control programming in JavaScript.</p>
<h2 id="promises"><a name="promises" class="anchor-navigation-ex-anchor" href="#promises"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. Promises</h2>
<p>Let&apos;s clear up some misconceptions: Promises are not about replacing callbacks. Promises provide a trustable intermediary -- that is, between your calling code and the async code that will perform the task -- to manage callbacks.</p>
<p>Another way of thinking about a Promise is as an event listener, on which you can register to listen for an event that lets you know when a task has completed. It&apos;s an event that will only ever fire once, but it can be thought of as an event nonetheless.</p>
<p>Promises can be chained together, which can sequence a series of asychronously completing steps. Together with higher-level abstractions like the <code>all(..)</code> method (in classic terms, a &quot;gate&quot;) and the <code>race(..)</code> method (in classic terms, a &quot;latch&quot;), promise chains provide a mechanism for async flow control.</p>
<p>Yet another way of conceptualizing a Promise is that it&apos;s a <em>future value</em>, a time-independent container wrapped around a value. This container can be reasoned about identically whether the underlying value is final or not. Observing the resolution of a Promise extracts this value once available. In other words, a Promise is said to be the async version of a sync function&apos;s return value.</p>
<p>A Promise can only have one of two possible resolution outcomes: fulfilled or rejected, with an optional single value. If a Promise is fulfilled, the final value is called a fulfillment. If it&apos;s rejected, the final value is called a reason (as in, a &quot;reason for rejection&quot;). Promises can only be resolved (fulfillment or rejection) <em>once</em>. Any further attempts to fulfill or reject are simply ignored. Thus, once a Promise is resolved, it&apos;s an immutable value that cannot be changed.</p>
<p>Clearly, there are several different ways to think about what a Promise is. No single perspective is fully sufficient, but each provides a separate aspect of the whole. The big takeaway is that they offer a significant improvement over callbacks-only async, namely that they provide order, predictability, and trustability.</p>
<h3 id="making-and-using-promises"><a name="making-and-using-promises" class="anchor-navigation-ex-anchor" href="#making-and-using-promises"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.1. Making and Using Promises</h3>
<p>To construct a promise instance, use the <code>Promise(..)</code> constructor:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The <code>Promise(..)</code> constructor takes a single function (<code>pr(..)</code>), which is called immediately and receives two control functions as arguments, usually named <code>resolve(..)</code> and <code>reject(..)</code>. They are used as:</p>
<ul>
<li>If you call <code>reject(..)</code>, the promise is rejected, and if any value is passed to <code>reject(..)</code>, it is set as the reason for rejection.</li>
<li>If you call <code>resolve(..)</code> with no value, or any non-promise value, the promise is fulfilled.</li>
<li>If you call <code>resolve(..)</code> and pass another promise, this promise simply adopts the state -- whether immediate or eventual -- of the passed promise (either fulfillment or rejection).</li>
</ul>
<p>Here&apos;s how you&apos;d typically use a promise to refactor a callback-reliant function call. If you start out with an <code>ajax(..)</code> utility that expects to be able to call an error-first style callback:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">ajax</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// make request, eventually call `cb(..)`</span>
<span class="token punctuation">}</span>

<span class="token comment">// ..</span>

<span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle ajax error</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle `contents` success</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>You can convert it to:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">ajax</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// make request, eventually call</span>
        <span class="token comment">// either `resolve(..)` or `reject(..)`</span>
    <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ..</span>

<span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// handle `contents` success</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// handle ajax error reason</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Promises have a <code>then(..)</code> method that accepts one or two callback functions. The first function (if present) is treated as the handler to call if the promise is fulfilled successfully. The second function (if present) is treated as the handler to call if the promise is rejected explicitly, or if any error/exception is caught during resolution.</p>
<p>If one of the arguments is omitted or otherwise not a valid function -- typically you&apos;ll use <code>null</code> instead -- a default placeholder equivalent is used. The default success callback passes its fulfillment value along and the default error callback propagates its rejection reason along.</p>
<p>The shorthand for calling <code>then(null,handleRejection)</code> is <code>catch(handleRejection)</code>.</p>
<p>Both <code>then(..)</code> and <code>catch(..)</code> automatically construct and return another promise instance, which is wired to receive the resolution from whatever the return value is from the original promise&apos;s fulfillment or rejection handler (whichever is actually called). Consider:</p>
<pre class="language-"><code class="lang-js"><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> contents<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;DEFAULT VALUE&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// handle data from original promise&apos;s</span>
    <span class="token comment">// handlers</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>In this snippet, we&apos;re returning an immediate value from either <code>fulfilled(..)</code> or <code>rejected(..)</code>, which then is received on the next event turn in the second <code>then(..)</code>&apos;s <code>fulfilled(..)</code>. If we instead return a new promise, that new promise is subsumed and adopted as the resolution:</p>
<pre class="language-"><code class="lang-js"><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ajax</span><span class="token punctuation">(</span>
            <span class="token string">&quot;http://some.url.2?v=&quot;</span> <span class="token operator">+</span> contents
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ajax</span><span class="token punctuation">(</span>
            <span class="token string">&quot;http://backup.url.3?err=&quot;</span> <span class="token operator">+</span> reason
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// `contents` comes from the subsequent</span>
    <span class="token comment">// `ajax(..)` call, whichever it was</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>It&apos;s important to note that an exception (or rejected promise) in the first <code>fulfilled(..)</code> will <em>not</em> result in the first <code>rejected(..)</code> being called, as that handler only responds to the resolution of the first original promise. Instead, the second promise, which the second <code>then(..)</code> is called against, receives that rejection.</p>
<p>In this previous snippet, we are not listening for that rejection, which means it will be silently held onto for future observation. If you never observe it by calling a <code>then(..)</code> or <code>catch(..)</code>, then it will go unhandled. Some browser developer consoles may detect these unhandled rejections and report them, but this is not reliably guaranteed; you should always observe promise rejections.</p>
<p><strong>Note:</strong> This was just a brief overview of Promise theory and behavior. For a much more in-depth exploration, see Chapter 3 of the <em>Async &amp; Performance</em> title of this series.</p>
<h3 id="thenables"><a name="thenables" class="anchor-navigation-ex-anchor" href="#thenables"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.2. Thenables</h3>
<p>Promises are genuine instances of the <code>Promise(..)</code> constructor. However, there are promise-like objects called <em>thenables</em> that generally can interoperate with the Promise mechanisms.</p>
<p>Any object (or function) with a <code>then(..)</code> function on it is assumed to be a thenable. Any place where the Promise mechanisms can accept and adopt the state of a genuine promise, they can also handle a thenable.</p>
<p>Thenables are basically a general label for any promise-like value that may have been created by some other system than the actual <code>Promise(..)</code> constructor. In that perspective, a thenable is generally less trustable than a genuine Promise. Consider this misbehaving thenable, for example:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">var</span> th <span class="token operator">=</span> <span class="token punctuation">{</span>
    then<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">thener</span><span class="token punctuation">(</span> fulfilled <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// call `fulfilled(..)` once every 100ms forever</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span> fulfilled<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>If you received that thenable and chained it with <code>th.then(..)</code>, you&apos;d likely be surprised that your fulfillment handler is called repeatedly, when normal Promises are supposed to only ever be resolved once.</p>
<p>Generally, if you&apos;re receiving what purports to be a promise or thenable back from some other system, you shouldn&apos;t just trust it blindly. In the next section, we&apos;ll see a utility included with ES6 Promises that helps address this trust concern.</p>
<p>But to further understand the perils of this issue, consider that <em>any</em> object in <em>any</em> piece of code that&apos;s ever been defined to have a method on it called <code>then(..)</code> can be potentially confused as a thenable -- if used with Promises, of course -- regardless of if that thing was ever intended to even remotely be related to Promise-style async coding.</p>
<p>Prior to ES6, there was never any special reservation made on methods called <code>then(..)</code>, and as you can imagine there&apos;s been at least a few cases where that method name has been chosen prior to Promises ever showing up on the radar screen. The most likely case of mistaken thenable will be async libraries that use <code>then(..)</code> but which are not strictly Promises-compliant -- there are several out in the wild.</p>
<p>The onus will be on you to guard against directly using values with the Promise mechanism that would be incorrectly assumed to be a thenable.</p>
<h3 id="promise-api"><a name="promise-api" class="anchor-navigation-ex-anchor" href="#promise-api"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.3. Promise API</h3>
<p>The <code>Promise</code> API also provides some static methods for working with Promises.</p>
<p><code>Promise.resolve(..)</code> creates a promise resolved to the value passed in. Let&apos;s compare how it works to the more manual approach:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token number">42</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token number">42</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>p1</code> and <code>p2</code> will have essentially identical behavior. The same goes for resolving with a promise:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">var</span> theP <span class="token operator">=</span> <span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> theP <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span> theP <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>Tip:</strong> <code>Promise.resolve(..)</code> is the solution to the thenable trust issue raised in the previous section. Any value that you are not already certain is a trustable promise -- even if it could be an immediate value -- can be normalized by passing it to <code>Promise.resolve(..)</code>. If the value is already a recognizable promise or thenable, its state/resolution will simply be adopted, insulating you from misbehavior. If it&apos;s instead an immediate value, it will be &quot;wrapped&quot; in a genuine promise, thereby normalizing its behavior to be async.</p>
<p><code>Promise.reject(..)</code> creates an immediately rejected promise, the same as its <code>Promise(..)</code> constructor counterpart:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>While <code>resolve(..)</code> and <code>Promise.resolve(..)</code> can accept a promise and adopt its state/resolution, <code>reject(..)</code> and <code>Promise.reject(..)</code> do not differentiate what value they receive. So, if you reject with a promise or thenable, the promise/thenable itself will be set as the rejection reason, not its underlying value.</p>
<p><code>Promise.all([ .. ])</code> accepts an array of one or more values (e.g., immediate values, promises, thenables). It returns a promise back that will be fulfilled if all the values fulfill, or reject immediately once the first of any of them rejects.</p>
<p>Starting with these values/promises:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token number">42</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token number">43</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v3 <span class="token operator">=</span> <span class="token number">44</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">pr</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s consider how <code>Promise.all([ .. ])</code> works with combinations of those values:</p>
<pre class="language-"><code class="lang-js">Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">,</span>v3<span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>vals<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> vals <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// [42,43,44]</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">,</span>v3<span class="token punctuation">,</span>p4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>vals<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// never gets here</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> reason <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Oops</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>While <code>Promise.all([ .. ])</code> waits for all fulfillments (or the first rejection), <code>Promise.race([ .. ])</code> waits only for either the first fulfillment or rejection. Consider:</p>
<pre class="language-"><code class="lang-js"><span class="token comment">// NOTE: re-setup all test values to</span>
<span class="token comment">// avoid timing issues misleading you!</span>

Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>p2<span class="token punctuation">,</span>p1<span class="token punctuation">,</span>v3<span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 42</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>p2<span class="token punctuation">,</span>p4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// never gets here</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> reason <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Oops</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>Warning:</strong> While <code>Promise.all([])</code> will fulfill right away (with no values), <code>Promise.race([])</code> will hang forever. This is a strange inconsistency, and speaks to the suggestion that you should never use these methods with empty arrays.</p>
<h2 id="generators--promises"><a name="generators--promises" class="anchor-navigation-ex-anchor" href="#generators--promises"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. Generators + Promises</h2>
<p>It <em>is</em> possible to express a series of promises in a chain to represent the async flow control of your program. Consider:</p>
<pre class="language-"><code class="lang-js"><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    step2<span class="token punctuation">,</span>
    step1Failed
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">step3</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
            <span class="token function">step3a</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">step3b</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">step3c</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span>
        <span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step4<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>However, there&apos;s a much better option for expressing async flow control, and it will probably be much more preferable in terms of coding style than long promise chains. We can use what we learned in Chapter 3 about generators to express our async flow control.</p>
<p>The important pattern to recognize: a generator can yield a promise, and that promise can then be wired to resume the generator with its fulfillment value.</p>
<p>Consider the previous snippet&apos;s async flow control expressed with a generator:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step1Failed</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">step2</span><span class="token punctuation">(</span> ret <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// step 3</span>
    ret <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
        <span class="token function">step3a</span><span class="token punctuation">(</span> ret <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">step3b</span><span class="token punctuation">(</span> ret <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">step3c</span><span class="token punctuation">(</span> ret <span class="token punctuation">)</span>
    <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">yield</span> <span class="token function">step4</span><span class="token punctuation">(</span> ret <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>On the surface, this snippet may seem more verbose than the promise chain equivalent in the earlier snippet. However, it offers a much more attractive -- and more importantly, a more understandable and reason-able -- synchronous-looking coding style (with <code>=</code> assignment of &quot;return&quot; values, etc.) That&apos;s especially true in that <code>try..catch</code> error handling can be used across those hidden async boundaries.</p>
<p>Why are we using Promises with the generator? It&apos;s certainly possible to do async generator coding without Promises.</p>
<p>Promises are a trustable system that uninverts the inversion of control of normal callbacks or thunks (see the <em>Async &amp; Performance</em> title of this series). So, combining the trustability of Promises and the synchronicity of code in generators effectively addresses all the major deficiencies of callbacks. Also, utilities like <code>Promise.all([ .. ])</code> are a nice, clean way to express concurrency at a generator&apos;s single <code>yield</code> step.</p>
<p>So how does this magic work? We&apos;re going to need a <em>runner</em> that can run our generator, receive a <code>yield</code>ed promise, and wire it up to resume the generator with either the fulfillment success value, or throw an error into the generator with the rejection reason.</p>
<p>Many async-capable utilities/libraries have such a &quot;runner&quot;; for example, <code>Q.spawn(..)</code> and my asynquence&apos;s <code>runner(..)</code> plug-in. But here&apos;s a stand-alone runner to illustrate how the process works:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">;</span>

    it <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">handleNext</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">handleResult</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> next<span class="token punctuation">.</span>value <span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
                            handleNext<span class="token punctuation">,</span>
                            <span class="token keyword">function</span> <span class="token function">handleErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
                                    it<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span>
                                <span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> handleResult <span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span> next <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Note:</strong> For a more prolifically commented version of this utility, see the <em>Async &amp; Performance</em> title of this series. Also, the run utilities provided with various async libraries are often more powerful/capable than what we&apos;ve shown here. For example, asynquence&apos;s <code>runner(..)</code> can handle <code>yield</code>ed promises, sequences, thunks, and immediate (non-promise) values, giving you ultimate flexibility.</p>
<p>So now running <code>*main()</code> as listed in the earlier snippet is as easy as:</p>
<pre class="language-"><code class="lang-js"><span class="token function">run</span><span class="token punctuation">(</span> main <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// `*main()` completed successfully</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// Oops, something went wrong</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Essentially, anywhere that you have more than two asynchronous steps of flow control logic in your program, you can <em>and should</em> use a promise-yielding generator driven by a run utility to express the flow control in a synchronous fashion. This will make for much easier to understand and maintain code.</p>
<p>This yield-a-promise-resume-the-generator pattern is going to be so common and so powerful, the next version of JavaScript after ES6 is almost certainly going to introduce a new function type that will do it automatically without needing the run utility. We&apos;ll cover <code>async function</code>s (as they&apos;re expected to be called) in Chapter 8.</p>
<h2 id="review"><a name="review" class="anchor-navigation-ex-anchor" href="#review"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. Review</h2>
<p>As JavaScript continues to mature and grow in its widespread adoption, asynchronous programming is more and more of a central concern. Callbacks are not fully sufficient for these tasks, and totally fall down the more sophisticated the need.</p>
<p>Thankfully, ES6 adds Promises to address one of the major shortcomings of callbacks: lack of trust in predictable behavior. Promises represent the future completion value from a potentially async task, normalizing behavior across sync and async boundaries.</p>
<p>But it&apos;s the combination of Promises with generators that fully realizes the benefits of rearranging our async flow control code to de-emphasize and abstract away that ugly callback soup (aka &quot;hell&quot;).</p>
<p>Right now, we can manage these interactions with the aide of various async libraries&apos; runners, but JavaScript is eventually going to support this interaction pattern with dedicated syntax alone!</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ch3.html" class="navigation navigation-prev " aria-label="Previous page: Chapter 3: Organization">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ch5.html" class="navigation navigation-next " aria-label="Next page: Chapter 5: Collections">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Chapter 4: Async Flow Control","level":"1.8.5","depth":2,"next":{"title":"Chapter 5: Collections","level":"1.8.6","depth":2,"path":"ES6 & Beyond/ch5.md","ref":"ES6 & Beyond/ch5.md","articles":[]},"previous":{"title":"Chapter 3: Organization","level":"1.8.4","depth":2,"path":"ES6 & Beyond/ch3.md","ref":"ES6 & Beyond/ch3.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-lunr","-sharing","-livereload","-search","search-plus","anchor-navigation-ex","splitter","prism","theme-comscore","livereload"],"pluginsConfig":{"anchor-navigation-ex":{"associatedWithSummary":false,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showGoTop":true,"showLevel":true},"prism":{"css":["prismjs/themes/prism-okaidia.css"]},"search-plus":{},"splitter":{},"highlight":{},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-comscore":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"ES6 & Beyond/ch4.md","mtime":"2018-09-23T00:16:07.280Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-09-23T02:41:01.827Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

